import S from"../quickselect@3.0.0/index.ca231cf5.js";class E{constructor(t=9){this._maxEntries=Math.max(4,t),this._minEntries=Math.max(2,Math.ceil(this._maxEntries*.4)),this.clear()}all(){return this._all(this.data,[])}search(t){let n=this.data;const i=[];if(!M(t,n))return i;const r=this.toBBox,e=[];for(;n;){for(let s=0;s<n.children.length;s++){const a=n.children[s],o=n.leaf?r(a):a;M(t,o)&&(n.leaf?i.push(a):Y(t,o)?this._all(a,i):e.push(a))}n=e.pop()}return i}collides(t){let n=this.data;if(!M(t,n))return!1;const i=[];for(;n;){for(let r=0;r<n.children.length;r++){const e=n.children[r],s=n.leaf?this.toBBox(e):e;if(M(t,s)){if(n.leaf||Y(t,s))return!0;i.push(e)}}n=i.pop()}return!1}load(t){if(!(t&&t.length))return this;if(t.length<this._minEntries){for(let i=0;i<t.length;i++)this.insert(t[i]);return this}let n=this._build(t.slice(),0,t.length-1,0);if(!this.data.children.length)this.data=n;else if(this.data.height===n.height)this._splitRoot(this.data,n);else{if(this.data.height<n.height){const i=this.data;this.data=n,n=i}this._insert(n,this.data.height-n.height-1,!0)}return this}insert(t){return t&&this._insert(t,this.data.height-1),this}clear(){return this.data=f([]),this}remove(t,n){if(!t)return this;let i=this.data;const r=this.toBBox(t),e=[],s=[];let a,o,c;for(;i||e.length;){if(i||(i=e.pop(),o=e[e.length-1],a=s.pop(),c=!0),i.leaf){const l=b(t,i.children,n);if(l!==-1)return i.children.splice(l,1),e.push(i),this._condense(e),this}!c&&!i.leaf&&Y(i,r)?(e.push(i),s.push(a),a=0,o=i,i=i.children[0]):o?(a++,i=o.children[a],c=!1):i=null}return this}toBBox(t){return t}compareMinX(t,n){return t.minX-n.minX}compareMinY(t,n){return t.minY-n.minY}toJSON(){return this.data}fromJSON(t){return this.data=t,this}_all(t,n){const i=[];for(;t;)t.leaf?n.push(...t.children):i.push(...t.children),t=i.pop();return n}_build(t,n,i,r){const e=i-n+1;let s=this._maxEntries,a;if(e<=s)return a=f(t.slice(n,i+1)),u(a,this.toBBox),a;r||(r=Math.ceil(Math.log(e)/Math.log(s)),s=Math.ceil(e/Math.pow(s,r-1))),a=f([]),a.leaf=!1,a.height=r;const o=Math.ceil(e/s),c=o*Math.ceil(Math.sqrt(s));_(t,n,i,c,this.compareMinX);for(let l=n;l<=i;l+=c){const m=Math.min(l+c-1,i);_(t,l,m,o,this.compareMinY);for(let p=l;p<=m;p+=o){const B=Math.min(p+o-1,m);a.children.push(this._build(t,p,B,r-1))}}return u(a,this.toBBox),a}_chooseSubtree(t,n,i,r){for(;r.push(n),!(n.leaf||r.length-1===i);){let e=1/0,s=1/0,a;for(let o=0;o<n.children.length;o++){const c=n.children[o],l=X(c),m=D(t,c)-l;m<s?(s=m,e=l<e?l:e,a=c):m===s&&l<e&&(e=l,a=c)}n=a||n.children[0]}return n}_insert(t,n,i){const r=i?t:this.toBBox(t),e=[],s=this._chooseSubtree(r,this.data,n,e);for(s.children.push(t),d(s,r);n>=0&&e[n].children.length>this._maxEntries;)this._split(e,n),n--;this._adjustParentBBoxes(r,e,n)}_split(t,n){const i=t[n],r=i.children.length,e=this._minEntries;this._chooseSplitAxis(i,e,r);const s=this._chooseSplitIndex(i,e,r),a=f(i.children.splice(s,i.children.length-s));a.height=i.height,a.leaf=i.leaf,u(i,this.toBBox),u(a,this.toBBox),n?t[n-1].children.push(a):this._splitRoot(i,a)}_splitRoot(t,n){this.data=f([t,n]),this.data.height=t.height+1,this.data.leaf=!1,u(this.data,this.toBBox)}_chooseSplitIndex(t,n,i){let r,e=1/0,s=1/0;for(let a=n;a<=i-n;a++){const o=x(t,0,a,this.toBBox),c=x(t,a,i,this.toBBox),l=I(o,c),m=X(o)+X(c);l<e?(e=l,r=a,s=m<s?m:s):l===e&&m<s&&(s=m,r=a)}return r||i-n}_chooseSplitAxis(t,n,i){const r=t.leaf?this.compareMinX:O,e=t.leaf?this.compareMinY:A,s=this._allDistMargin(t,n,i,r),a=this._allDistMargin(t,n,i,e);s<a&&t.children.sort(r)}_allDistMargin(t,n,i,r){t.children.sort(r);const e=this.toBBox,s=x(t,0,n,e),a=x(t,i-n,i,e);let o=g(s)+g(a);for(let c=n;c<i-n;c++){const l=t.children[c];d(s,t.leaf?e(l):l),o+=g(s)}for(let c=i-n-1;c>=n;c--){const l=t.children[c];d(a,t.leaf?e(l):l),o+=g(a)}return o}_adjustParentBBoxes(t,n,i){for(let r=i;r>=0;r--)d(n[r],t)}_condense(t){for(let n=t.length-1,i;n>=0;n--)t[n].children.length===0?n>0?(i=t[n-1].children,i.splice(i.indexOf(t[n]),1)):this.clear():u(t[n],this.toBBox)}}function b(h,t,n){if(!n)return t.indexOf(h);for(let i=0;i<t.length;i++)if(n(h,t[i]))return i;return-1}function u(h,t){x(h,0,h.children.length,t,h)}function x(h,t,n,i,r){r||(r=f(null)),r.minX=1/0,r.minY=1/0,r.maxX=-1/0,r.maxY=-1/0;for(let e=t;e<n;e++){const s=h.children[e];d(r,h.leaf?i(s):s)}return r}function d(h,t){return h.minX=Math.min(h.minX,t.minX),h.minY=Math.min(h.minY,t.minY),h.maxX=Math.max(h.maxX,t.maxX),h.maxY=Math.max(h.maxY,t.maxY),h}function O(h,t){return h.minX-t.minX}function A(h,t){return h.minY-t.minY}function X(h){return(h.maxX-h.minX)*(h.maxY-h.minY)}function g(h){return h.maxX-h.minX+(h.maxY-h.minY)}function D(h,t){return(Math.max(t.maxX,h.maxX)-Math.min(t.minX,h.minX))*(Math.max(t.maxY,h.maxY)-Math.min(t.minY,h.minY))}function I(h,t){const n=Math.max(h.minX,t.minX),i=Math.max(h.minY,t.minY),r=Math.min(h.maxX,t.maxX),e=Math.min(h.maxY,t.maxY);return Math.max(0,r-n)*Math.max(0,e-i)}function Y(h,t){return h.minX<=t.minX&&h.minY<=t.minY&&t.maxX<=h.maxX&&t.maxY<=h.maxY}function M(h,t){return t.minX<=h.maxX&&t.minY<=h.maxY&&t.maxX>=h.minX&&t.maxY>=h.minY}function f(h){return{children:h,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function _(h,t,n,i,r){const e=[t,n];for(;e.length;){if(n=e.pop(),t=e.pop(),n-t<=i)continue;const s=t+Math.ceil((n-t)/i/2)*i;S(h,s,t,n,r),e.push(t,s,s,n)}}export{E as default};
