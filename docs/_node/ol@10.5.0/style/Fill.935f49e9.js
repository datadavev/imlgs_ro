var o={IDLE:0,LOADING:1,LOADED:2,ERROR:3};const d=typeof navigator<"u"&&typeof navigator.userAgent<"u"?navigator.userAgent.toLowerCase():"",$=d.includes("safari")&&!d.includes("chrom");$&&(d.includes("version/15.4")||/cpu (os|iphone os) 15_4 like mac os x/.test(d)),d.includes("webkit")&&d.includes("edge"),d.includes("macintosh");const A=typeof WorkerGlobalScope<"u"&&typeof OffscreenCanvas<"u"&&self instanceof WorkerGlobalScope,z=typeof Image<"u"&&Image.prototype.decode;(function(){let t=!1;try{const e=Object.defineProperty({},"passive",{get:function(){t=!0}});window.addEventListener("_",null,e),window.removeEventListener("_",null,e)}catch{}return t})();function _(t,e,i,s){let n;return A?n=new OffscreenCanvas(t||300,e||300):n=document.createElement("canvas"),t&&(n.width=t),e&&(n.height=e),n.getContext("2d",s)}let y;function D(){return y||(y=_(1,1)),y}function p(t,e,i){return Math.min(Math.max(t,e),i)}function N(t,e){const i=Math.pow(10,e);return Math.round(t*i)/i}const x=[NaN,NaN,NaN,0];let E;function P(){return E||(E=_(1,1,void 0,{willReadFrequently:!0,desynchronized:!0})),E}const G=/^rgba?\(\s*(\d+%?)\s+(\d+%?)\s+(\d+%?)(?:\s*\/\s*(\d+%|\d*\.\d+|[01]))?\s*\)$/i,M=/^rgba?\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)(?:\s*,\s*(\d+%|\d*\.\d+|[01]))?\s*\)$/i,W=/^rgba?\(\s*(\d+%)\s*,\s*(\d+%)\s*,\s*(\d+%)(?:\s*,\s*(\d+%|\d*\.\d+|[01]))?\s*\)$/i,k=/^#([\da-f]{3,4}|[\da-f]{6}|[\da-f]{8})$/i;function v(t,e){return t.endsWith("%")?Number(t.substring(0,t.length-1))/e:Number(t)}function u(t){throw new Error('failed to parse "'+t+'" as color')}function R(t){if(t.toLowerCase().startsWith("rgb")){const a=t.match(M)||t.match(G)||t.match(W);if(a){const r=a[4],h=100/255;return[p(v(a[1],h)+.5|0,0,255),p(v(a[2],h)+.5|0,0,255),p(v(a[3],h)+.5|0,0,255),r!==void 0?p(v(r,100),0,1):1]}u(t)}if(t.startsWith("#")){if(k.test(t)){const a=t.substring(1),r=a.length<=4?1:2,h=[0,0,0,255];for(let l=0,c=a.length;l<c;l+=r){let g=parseInt(a.substring(l,l+r),16);r===1&&(g+=g<<4),h[l/r]=g}return h[3]=h[3]/255,h}u(t)}const e=P();e.fillStyle="#abcdef";let i=e.fillStyle;e.fillStyle=t,e.fillStyle===i&&(e.fillStyle="#fedcba",i=e.fillStyle,e.fillStyle=t,e.fillStyle===i&&u(t));const s=e.fillStyle;if(s.startsWith("#")||s.startsWith("rgba"))return R(s);e.clearRect(0,0,1,1),e.fillRect(0,0,1,1);const n=Array.from(e.getImageData(0,0,1,1).data);return n[3]=N(n[3]/255,3),n}function H(t){return typeof t=="string"?t:q(t)}const T=1024,f={};let S=0;function j(t){if(t==="none")return x;if(f.hasOwnProperty(t))return f[t];if(S>=T){let i=0;for(const s in f)i++&3||(delete f[s],--S)}const e=R(t);e.length!==4&&u(t);for(const i of e)isNaN(i)&&u(t);return f[t]=e,++S,e}function O(t){return Array.isArray(t)?t:j(t)}function q(t){let e=t[0];e!=(e|0)&&(e=e+.5|0);let i=t[1];i!=(i|0)&&(i=i+.5|0);let s=t[2];s!=(s|0)&&(s=s+.5|0);const n=t[3]===void 0?1:Math.round(t[3]*1e3)/1e3;return"rgba("+e+","+i+","+s+","+n+")"}let F=0;function K(t){return t.ol_uid||(t.ol_uid=String(++F))}var C={CHANGE:"change"};class B{constructor(){this.disposed=!1}dispose(){this.disposed||(this.disposed=!0,this.disposeInternal())}disposeInternal(){}}var J=B;function b(){}function Q(t){for(const e in t)delete t[e]}class U{constructor(e){this.propagationStopped,this.defaultPrevented,this.type=e,this.target=null}preventDefault(){this.defaultPrevented=!0}stopPropagation(){this.propagationStopped=!0}}var V=U;class X extends J{constructor(e){super(),this.eventTarget_=e,this.pendingRemovals_=null,this.dispatching_=null,this.listeners_=null}addEventListener(e,i){if(!e||!i)return;const s=this.listeners_||(this.listeners_={}),n=s[e]||(s[e]=[]);n.includes(i)||n.push(i)}dispatchEvent(e){const i=typeof e=="string",s=i?e:e.type,n=this.listeners_&&this.listeners_[s];if(!n)return;const a=i?new V(e):e;a.target||(a.target=this.eventTarget_||this);const r=this.dispatching_||(this.dispatching_={}),h=this.pendingRemovals_||(this.pendingRemovals_={});s in r||(r[s]=0,h[s]=0),++r[s];let l;for(let c=0,g=n.length;c<g;++c)if("handleEvent"in n[c]?l=n[c].handleEvent(a):l=n[c].call(this,a),l===!1||a.propagationStopped){l=!1;break}if(--r[s]===0){let c=h[s];for(delete h[s];c--;)this.removeEventListener(s,b);delete r[s]}return l}disposeInternal(){this.listeners_&&Q(this.listeners_)}getListeners(e){return this.listeners_&&this.listeners_[e]||void 0}hasListener(e){return this.listeners_?e?e in this.listeners_:Object.keys(this.listeners_).length>0:!1}removeEventListener(e,i){if(!this.listeners_)return;const s=this.listeners_[e];if(!s)return;const n=s.indexOf(i);n!==-1&&(this.pendingRemovals_&&e in this.pendingRemovals_?(s[n]=b,++this.pendingRemovals_[e]):(s.splice(n,1),s.length===0&&delete this.listeners_[e]))}}var Y=X;function Z(t,e){return new Promise((i,s)=>{function n(){r(),i(t)}function a(){r(),s(new Error("Image load error"))}function r(){t.removeEventListener("load",n),t.removeEventListener("error",a)}t.addEventListener("load",n),t.addEventListener("error",a)})}function ee(t,e){return e&&(t.src=e),t.src&&z?new Promise((i,s)=>t.decode().then(()=>i(t)).catch(n=>t.complete&&t.width?i(t):s(n))):Z(t)}let te=class{constructor(){this.cache_={},this.patternCache_={},this.cacheSize_=0,this.maxCacheSize_=1024}clear(){this.cache_={},this.patternCache_={},this.cacheSize_=0}canExpireCache(){return this.cacheSize_>this.maxCacheSize_}expire(){if(this.canExpireCache()){let e=0;for(const i in this.cache_){const s=this.cache_[i];!(e++&3)&&!s.hasListener()&&(delete this.cache_[i],delete this.patternCache_[i],--this.cacheSize_)}}}get(e,i,s){const n=L(e,i,s);return n in this.cache_?this.cache_[n]:null}getPattern(e,i,s){const n=L(e,i,s);return n in this.patternCache_?this.patternCache_[n]:null}set(e,i,s,n,a){const r=L(e,i,s),h=r in this.cache_;this.cache_[r]=n,a&&(n.getImageState()===o.IDLE&&n.load(),n.getImageState()===o.LOADING?n.ready().then(()=>{this.patternCache_[r]=D().createPattern(n.getImage(1),"repeat")}):this.patternCache_[r]=D().createPattern(n.getImage(1),"repeat")),h||++this.cacheSize_}setSize(e){this.maxCacheSize_=e,this.expire()}};function L(t,e,i){const s=i?O(i):"null";return e+":"+t+":"+s}const I=new te;let m=null;class ie extends Y{constructor(e,i,s,n,a){super(),this.hitDetectionImage_=null,this.image_=e,this.crossOrigin_=s,this.canvas_={},this.color_=a,this.imageState_=n===void 0?o.IDLE:n,this.size_=e&&e.width&&e.height?[e.width,e.height]:null,this.src_=i,this.tainted_,this.ready_=null}initializeImage_(){this.image_=new Image,this.crossOrigin_!==null&&(this.image_.crossOrigin=this.crossOrigin_)}isTainted_(){if(this.tainted_===void 0&&this.imageState_===o.LOADED){m||(m=_(1,1,void 0,{willReadFrequently:!0})),m.drawImage(this.image_,0,0);try{m.getImageData(0,0,1,1),this.tainted_=!1}catch{m=null,this.tainted_=!0}}return this.tainted_===!0}dispatchChangeEvent_(){this.dispatchEvent(C.CHANGE)}handleImageError_(){this.imageState_=o.ERROR,this.dispatchChangeEvent_()}handleImageLoad_(){this.imageState_=o.LOADED,this.size_=[this.image_.width,this.image_.height],this.dispatchChangeEvent_()}getImage(e){return this.image_||this.initializeImage_(),this.replaceColor_(e),this.canvas_[e]?this.canvas_[e]:this.image_}getPixelRatio(e){return this.replaceColor_(e),this.canvas_[e]?e:1}getImageState(){return this.imageState_}getHitDetectionImage(){if(this.image_||this.initializeImage_(),!this.hitDetectionImage_)if(this.isTainted_()){const e=this.size_[0],i=this.size_[1],s=_(e,i);s.fillRect(0,0,e,i),this.hitDetectionImage_=s.canvas}else this.hitDetectionImage_=this.image_;return this.hitDetectionImage_}getSize(){return this.size_}getSrc(){return this.src_}load(){if(this.imageState_===o.IDLE){this.image_||this.initializeImage_(),this.imageState_=o.LOADING;try{this.src_!==void 0&&(this.image_.src=this.src_)}catch{this.handleImageError_()}this.image_ instanceof HTMLImageElement&&ee(this.image_,this.src_).then(e=>{this.image_=e,this.handleImageLoad_()}).catch(this.handleImageError_.bind(this))}}replaceColor_(e){if(!this.color_||this.canvas_[e]||this.imageState_!==o.LOADED)return;const i=this.image_,s=_(Math.ceil(i.width*e),Math.ceil(i.height*e)),n=s.canvas;s.scale(e,e),s.drawImage(i,0,0),s.globalCompositeOperation="multiply",s.fillStyle=H(this.color_),s.fillRect(0,0,n.width/e,n.height/e),s.globalCompositeOperation="destination-in",s.drawImage(i,0,0),this.canvas_[e]=n}ready(){return this.ready_||(this.ready_=new Promise(e=>{if(this.imageState_===o.LOADED||this.imageState_===o.ERROR)e();else{const i=()=>{(this.imageState_===o.LOADED||this.imageState_===o.ERROR)&&(this.removeEventListener(C.CHANGE,i),e())};this.addEventListener(C.CHANGE,i)}})),this.ready_}}function se(t,e,i,s,n,a){let r=e===void 0?void 0:I.get(e,i,n);return r||(r=new ie(t,e,i,s,n),I.set(e,i,n,r,a)),a&&r&&!I.getPattern(e,i,n)&&I.set(e,i,n,r,a),r}class w{constructor(e){e=e||{},this.patternImage_=null,this.color_=null,e.color!==void 0&&this.setColor(e.color)}clone(){const e=this.getColor();return new w({color:Array.isArray(e)?e.slice():e||void 0})}getColor(){return this.color_}setColor(e){if(e!==null&&typeof e=="object"&&"src"in e){const i=se(null,e.src,"anonymous",void 0,e.offset?null:e.color?e.color:null,!(e.offset&&e.size));i.ready().then(()=>{this.patternImage_=null}),i.getImageState()===o.IDLE&&i.load(),i.getImageState()===o.LOADING&&(this.patternImage_=i)}this.color_=e}getKey(){const e=this.getColor();return e?e instanceof CanvasPattern||e instanceof CanvasGradient?K(e):typeof e=="object"&&"src"in e?e.src+":"+e.offset:O(e).toString():""}loading(){return!!this.patternImage_}ready(){return this.patternImage_?this.patternImage_.ready():Promise.resolve()}}var ne=w;export{ne as default};
